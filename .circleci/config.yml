orbs:
  win: circleci/windows@2.4.0

executors:
  node:
    parameters:
      image:
        type: string
        default: "22.13"
      gatsby_major:
        type: string
        default: "5"
    docker:
      - image: cimg/node:<< parameters.image >>
    environment:
      GATSBY_CPU_COUNT: 2
      COMPILER_OPTIONS: GATSBY_MAJOR=<< parameters.gatsby_major >>
      NODE_NO_WARNINGS: 1
      BROWSERSLIST_IGNORE_OLD_DATA: true
      # See https://sharp.pixelplumbing.com/install/#custom-libvips
      # libvips may or may not be installed in the CircleCI images we're using, but we
      # don't want to use it regardless, for consistency (and because it can cause problems)
      SHARP_IGNORE_GLOBAL_LIBVIPS: 1

  e2e18:
    docker:
      - image: "cypress/browsers:node-18.20.3-chrome-125.0.6422.141-1-ff-126.0.1-edge-125.0.2535.85-1"
    environment:
      GATSBY_CPU_COUNT: 2
      VERBOSE: 1

  e2e22:
    docker:
      - image: "cypress/browsers:node-22.13.1-chrome-133.0.6943.53-1-ff-135.0-edge-132.0.2957.140-1"
    environment:
      GATSBY_CPU_COUNT: 2
      VERBOSE: 1

aliases:
  install_node_modules: &install_node_modules
    run:
      name: Install node modules
      command: yarn

  check_lockfile: &check_lockfile
    run:
      name: Check for dirty lockfile
      command: ./scripts/check-lockfile.sh || exit 1

  validate_renovate: &validate_renovate
    run:
      name: Validate renovate-config
      command: (node scripts/renovate-config-generator.js && (git status --porcelain renovate.json5 | grep "M renovate.json5")) && (echo "Please run \"node scripts/renovate-config-generator.js\" to update renovate.json5" && exit 1) || npx -p renovate@31.28.5 renovate-config-validator .

  attach_to_bootstrap: &attach_to_bootstrap
    attach_workspace:
      at: ./

  ignore_master: &ignore_master
    filters:
      branches:
        ignore:
          - master

  ignore_docs: &ignore_docs
    filters:
      branches:
        ignore:
          - /docs.+/

  test_template: &test_template
    parallelism: 4
    parameters:
      npm_rebuild:
        type: boolean
        default: false
    steps:
      - checkout
      - run: ./scripts/assert-changed-files.sh "packages/*|.circleci/*"
      - <<: *attach_to_bootstrap
      - when:
          condition: << parameters.npm_rebuild >>
          steps:
            - run: npm rebuild
      - run:
          name: Run tests
          command: yarn jest --ci --runInBand  $(yarn -s jest --listTests | sed 's/\/home\/circleci\/project\///g' | circleci tests split)
          environment:
            NODE_OPTIONS: --max-old-space-size=2048
            GENERATE_JEST_REPORT: "true"
            JEST_JUNIT_OUTPUT_DIR: ./test-results/jest-node/
            JEST_JUNIT_OUTPUT_NAME: results.xml
            JEST_JUNIT_REPORT_TEST_SUITE_ERRORS: "true"
      - store_test_results:
          path: ./test-results/jest-node/

  e2e-test-workflow: &e2e-test-workflow
    filters:
      branches:
        ignore:
          - master
          - /docs.+/
    matrix:
      parameters:
        node_version: ["18.2.0", "22.13"]
        e2e_executor_suffix: ["18", "22"]
      exclude:
        - node_version: "18.2.0"
          e2e_executor_suffix: "22"
        - node_version: "22.13"
          e2e_executor_suffix: "18"
    requires:
      - bootstrap-<< matrix.node_version >>

  integration-test-workflow: &integration-test-workflow
    filters:
      branches:
        ignore:
          - master
          - /docs.+/
    matrix:
      parameters:
        # TODO(serhalp): We test on 22.13 rather than the latest because there is an issue
        # introduced in node.js 22.14.0 (not present in 22.13.1) and node.js 20.19.0 (not present in
        # 20.18.3). It seems almost certainly to be caused by https://github.com/nodejs/node/pull/56106.
        # I'm not sure yet if this is only a test issue or an actual race condition that could
        # affect users - AFAICT the only manifestation is causing this test to fail:
        # https://github.com/gatsbyjs/gatsby/blob/c3708b068abba3a26e5cf229d6d4dc5813884acd/integration-tests/ssr/__tests__/ssr.js#L102.
        node_version: ["18.2.0", "22.13"]
    requires:
      - bootstrap-<< matrix.node_version >>

commands:
  restore_yarn_cache:
    parameters:
      node_version:
        type: string
    steps:
      - restore_cache:
          name: Restore node_modules cache
          keys:
            - yarn-cypress-cache-{{ checksum "yarn.lock" }}-<< parameters.node_version >>

  persist_yarn_cache:
    parameters:
      node_version:
        type: string
    steps:
      - save_cache:
          name: Save node modules cache
          key: yarn-cypress-cache-{{ checksum "yarn.lock" }}-<< parameters.node_version >>
          paths:
            - ~/.cache

  e2e-test:
    parameters:
      skip_file_change_test:
        type: boolean
        default: false
      trigger_pattern:
        type: string
        default: "packages/*|.circleci/*|scripts/e2e-test.sh"
      test_path:
        type: string
      test_command:
        type: string
        default: "yarn test"
      react_version:
        type: string
        default: ""
      slices:
        type: boolean
        default: true # allow disabling it later when setting up partial hydration tests
      pre_gatsby_dev_command:
        type: string
        default: ""
    steps:
      - checkout
      # In case of failure, add these steps again. Cache probably got deleted
      #- restore_yarn_cache:
      #    node_version: << parameters.node_version >>
      #- <<: *install_node_modules
      #- persist_yarn_cache:
      #    node_version: << parameters.node_version >>
      - unless:
          condition: << parameters.skip_file_change_test >>
          steps:
            - run: ./scripts/assert-changed-files.sh "<< parameters.trigger_pattern >>|<< parameters.test_path >>/*"

      - when:
          condition: << parameters.slices >>
          steps:
            - run: echo 'export GATSBY_SLICES="true"' >> "$BASH_ENV"

      - <<: *attach_to_bootstrap
      - when:
          condition:
            not:
              equal: ["", << parameters.react_version >>]
          steps:
            - run:
                name: Upgrade React to << parameters.react_version >>
                command: "REACT_VERSION=<< parameters.react_version >> TEST_PATH=<< parameters.test_path >> node ./scripts/upgrade-react"
      - run:
          name: Install gatsby-dev@next
          command: yarn global add gatsby-dev-cli@next --ignore-engines
      - run:
          name: Run tests (using defaults)
          command: ./scripts/e2e-test.sh "<< parameters.test_path >>" "<< parameters.test_command >>" "<< parameters.pre_gatsby_dev_command >>"

version: 2.1

jobs:
  bootstrap:
    parameters:
      node_version:
        type: string
    executor:
      name: node
      image: << parameters.node_version >>
    steps:
      - checkout
      - run: ./scripts/assert-changed-files.sh "packages/*|(e2e|integration)-tests/*|.circleci/*|scripts/e2e-test.sh|yarn.lock"
      # python is not built in and node-gyp needs it to build lmdb
      - run: sudo apt-get update && sudo apt-get install -y python3 python-is-python3
      - restore_yarn_cache:
          node_version: << parameters.node_version >>
      - <<: *install_node_modules
      - <<: *check_lockfile
      - <<: *validate_renovate
      - persist_yarn_cache:
          node_version: << parameters.node_version >>
      - run: yarn bootstrap -- concurrency=2
      # Persist the workspace again with all packages already built
      - persist_to_workspace:
          root: ./
          paths:
            - "packages/"
            - "node_modules/"

  lint:
    executor: node
    steps:
      - checkout
      # installation of dependencies takes a while because of the 100 packages we have inside the monorepo
      # Linting only needs the root packages, we remove the workspace and only install root packages
      - run:
          name: "remove workspaces from package.json"
          command: |
            sed -i ':a;N;$!ba;s/,\n\s*"workspaces":\s\[[^]]*]/,"workspaces":\["packages\/babel-preset-gatsby"\]/g' package.json
      - <<: *install_node_modules
      - run: yarn lint:code
      - run: yarn lint:other

  typecheck:
    executor: node
    steps:
      - checkout
      # We should always assert on master
      - run: ./scripts/assert-changed-files.sh "packages/*|.circleci/*|yarn.lock"
      - <<: *attach_to_bootstrap
      - run: yarn typecheck
      - run: yarn check-repo-fields

  unit_tests_node18:
    executor:
      name: node
      image: "18.2.0"
    <<: *test_template

  unit_tests_node20:
    executor:
      name: node
      image: "20.19"
    <<: *test_template

  unit_tests_node22:
    executor:
      name: node
      image: "22.13"
    <<: *test_template

  integration_tests_gatsby_source_wordpress:
    parameters:
      node_version:
        type: string
    machine:
      image: "ubuntu-2204:2023.02.1"
    steps:
      - run:
          command: |
            echo 'export NVM_DIR="$HOME/.nvm"' >> $BASH_ENV
            echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> $BASH_ENV
            echo nvm install v<< parameters.node_version >> >> $BASH_ENV
            echo nvm alias default v<< parameters.node_version >> >> $BASH_ENV
      - run: |
          node -v
      - run: npm i -g yarn@1.22.11
      - e2e-test:
          test_path: integration-tests/gatsby-source-wordpress

  integration_tests_long_term_caching:
    parameters:
      node_version:
        type: string
    executor:
      name: node
      image: << parameters.node_version >>
    steps:
      - e2e-test:
          test_path: integration-tests/long-term-caching
          test_command: yarn test

  integration_tests_cache_resilience:
    parameters:
      node_version:
        type: string
    executor:
      name: node
      image: << parameters.node_version >>
    steps:
      - e2e-test:
          test_path: integration-tests/cache-resilience
          test_command: yarn test

  integration_tests_gatsby_pipeline:
    parameters:
      node_version:
        type: string
    executor:
      name: node
      image: << parameters.node_version >>
    steps:
      - e2e-test:
          test_path: integration-tests/gatsby-pipeline
          test_command: yarn test

  integration_tests_gatsby_cli:
    parameters:
      node_version:
        type: string
    executor:
      name: node
      image: << parameters.node_version >>
    steps:
      - e2e-test:
          test_path: integration-tests/gatsby-cli
          test_command: yarn test

  integration_tests_structured_logging:
    parameters:
      node_version:
        type: string
    executor:
      name: node
      image: << parameters.node_version >>
    steps:
      - e2e-test:
          test_path: integration-tests/structured-logging
          test_command: yarn test

  integration_tests_artifacts:
    parameters:
      node_version:
        type: string
    executor:
      name: node
      image: << parameters.node_version >>
    steps:
      - e2e-test:
          test_path: integration-tests/artifacts
          test_command: yarn test

  integration_tests_ssr:
    parameters:
      node_version:
        type: string
    executor:
      name: node
      image: << parameters.node_version >>
    steps:
      - e2e-test:
          test_path: integration-tests/ssr
          test_command: yarn test

  integration_tests_images:
    parameters:
      node_version:
        type: string
    executor:
      name: node
      image: << parameters.node_version >>
    steps:
      - e2e-test:
          test_path: integration-tests/images
          test_command: yarn build-and-test
      - store_artifacts:
          path: integration-tests/images/__diff_output__

  integration_tests_functions:
    parameters:
      node_version:
        type: string
    executor:
      name: node
      image: << parameters.node_version >>
    steps:
      - e2e-test:
          test_path: integration-tests/functions
          test_command: yarn test

  integration_tests_head_function_export:
    parameters:
      node_version:
        type: string
    executor:
      name: node
      image: << parameters.node_version >>
    steps:
      - e2e-test:
          test_path: integration-tests/head-function-export
          test_command: yarn test

  integration_tests_esm_in_gatsby_files:
    parameters:
      node_version:
        type: string
    executor:
      name: node
      image: << parameters.node_version >>
    steps:
      - e2e-test:
          test_path: integration-tests/esm-in-gatsby-files
          test_command: yarn test

  integration_tests_lmdb_regeneration:
    parameters:
      node_version:
        type: string
    executor:
      name: node
      image: << parameters.node_version >>
    steps:
      - e2e-test:
          test_path: integration-tests/lmdb-regeneration
          test_command: yarn test

  e2e_tests_path-prefix:
    parameters:
      node_version:
        type: string
      e2e_executor_suffix:
        type: string
    executor: e2e<< parameters.e2e_executor_suffix >>
    steps:
      - e2e-test:
          test_path: e2e-tests/path-prefix

  e2e_tests_pnp:
    parameters:
      node_version:
        type: string
      e2e_executor_suffix:
        type: string
    executor: e2e<< parameters.e2e_executor_suffix >>
    steps:
      - checkout
      - run: ./scripts/assert-changed-files.sh "packages/*|.circleci/*"
      - <<: *attach_to_bootstrap
      - run:
          command: mkdir -p /tmp/e2e-tests/
          working_directory: ~/project
      - run:
          command: cp -r ./starters/default /tmp/e2e-tests/gatsby-pnp
          working_directory: ~/project
      - run: # default doesn't have API functions so let's get some of those
          command: cp -r ./e2e-tests/adapters/src/api /tmp/e2e-tests/gatsby-pnp/src/api
          working_directory: ~/project
      - run:
          command: touch yarn.lock
          working_directory: /tmp/e2e-tests/gatsby-pnp
      - run: # Quick upgrade to the v2 (any version, we just need the real set version)
          command: yarn policies set-version berry
          working_directory: /tmp/e2e-tests/gatsby-pnp
      - run: # Explicitly set nodeLinker to avoid Yarn selecting node_modules due to the Yarn 1.x lockfile
          command: yarn config set nodeLinker pnp
          working_directory: /tmp/e2e-tests/gatsby-pnp
      - run: # Allow installs to change the lockfile
          command: yarn config set enableImmutableInstalls false
          working_directory: /tmp/e2e-tests/gatsby-pnp
      - run: # Don't allow any fallback to root dependencies
          command: yarn config set pnpFallbackMode none
          working_directory: /tmp/e2e-tests/gatsby-pnp
      - run: # Install before custom registry server is set
          command: yarn add start-server-and-test@^1.11.0
          working_directory: /tmp/e2e-tests/gatsby-pnp
      - run: # Set the local registry to gatsby-dev-cli registry
          command: yarn config set npmRegistryServer http://localhost:4873
          working_directory: /tmp/e2e-tests/gatsby-pnp
      - run: # Allow localhost registry
          command: |
            echo -e 'unsafeHttpWhitelist:\n  - "localhost"' >> .yarnrc.yml
          working_directory: /tmp/e2e-tests/gatsby-pnp
      - run: # Set project dir
          command: node ~/project/packages/gatsby-dev-cli/dist/index.js --set-path-to-repo ~/project
          working_directory: /tmp/e2e-tests/gatsby-pnp
      - run: # Copy over packages
          command: node ~/project/packages/gatsby-dev-cli/dist/index.js --force-install --scan-once --external-registry
          working_directory: /tmp/e2e-tests/gatsby-pnp
      - run:
          command: yarn build
          working_directory: /tmp/e2e-tests/gatsby-pnp
      - run:
          command: 'DEBUG=start-server-and-test yarn start-server-and-test "yarn develop 2>&1 | tee log.txt" :8000 "! cat log.txt | grep -E ''ERROR #|Require stack:''"'
          working_directory: /tmp/e2e-tests/gatsby-pnp

  e2e_tests_pnpm:
    parameters:
      node_version:
        type: string
      e2e_executor_suffix:
        type: string
    executor: e2e<< parameters.e2e_executor_suffix >>
    steps:
      - checkout
      - run: ./scripts/assert-changed-files.sh "packages/*|.circleci/*"
      - <<: *attach_to_bootstrap
      - run:
          command: mkdir -p /tmp/e2e-tests/
          working_directory: ~/project
      - run:
          command: cp -r ./starters/default /tmp/e2e-tests/gatsby-pnpm
          working_directory: ~/project
      - run: # default doesn't have API functions so let's get some of those
          command: cp -r ./e2e-tests/adapters/src/api /tmp/e2e-tests/gatsby-pnpm/src/api
          working_directory: ~/project
      - run:
          command: rm package-lock.json
          working_directory: /tmp/e2e-tests/gatsby-pnpm
      - run: # Install pnpm
          command: npm install -g pnpm@9
          working_directory: /tmp/e2e-tests/gatsby-pnpm
      - run: # Install start-server-and-test
          command: npm install -g start-server-and-test@^1.11.0
          working_directory: /tmp/e2e-tests/gatsby-pnpm
      - run: # Set project dir
          command: node ~/project/packages/gatsby-dev-cli/dist/index.js --set-path-to-repo ~/project
          working_directory: /tmp/e2e-tests/gatsby-pnpm
      - run: # Copy over packages
          command: node ~/project/packages/gatsby-dev-cli/dist/index.js --force-install --scan-once --package-manager pnpm
          working_directory: /tmp/e2e-tests/gatsby-pnpm
      - run:
          command: pnpm build
          working_directory: /tmp/e2e-tests/gatsby-pnpm
      - run:
          command: 'DEBUG=start-server-and-test pnpm start-server-and-test "pnpm develop 2>&1 | tee log.txt" :8000 "! cat log.txt | grep -E ''ERROR #|Require stack:''"'
          working_directory: /tmp/e2e-tests/gatsby-pnpm

  e2e_tests_development_runtime_with_react_18:
    parameters:
      node_version:
        type: string
      e2e_executor_suffix:
        type: string
    executor: e2e<< parameters.e2e_executor_suffix >>
    steps:
      # We use curl in this test suite but it isn't available in all images we use
      - run: apt-get update && apt-get install -y curl
      - e2e-test:
          test_path: e2e-tests/development-runtime

  e2e_tests_development_runtime_with_react_19:
    parameters:
      node_version:
        type: string
      e2e_executor_suffix:
        type: string
    executor: e2e<< parameters.e2e_executor_suffix >>
    steps:
      # We use curl in this test suite but it isn't available in all images we use
      - run: apt-get update && apt-get install -y curl
      - e2e-test:
          test_path: e2e-tests/development-runtime
          react_version: "19.1.1"

  e2e_tests_production_runtime_with_react_18:
    parameters:
      node_version:
        type: string
      e2e_executor_suffix:
        type: string
    executor: e2e<< parameters.e2e_executor_suffix >>
    steps:
      - e2e-test:
          test_path: e2e-tests/production-runtime
          test_command: yarn test && yarn test:offline

  e2e_tests_production_runtime_with_react_19:
    parameters:
      node_version:
        type: string
      e2e_executor_suffix:
        type: string
    executor: e2e<< parameters.e2e_executor_suffix >>
    steps:
      - e2e-test:
          test_path: e2e-tests/production-runtime
          test_command: yarn test && yarn test:offline
          react_version: "19.1.1"

  e2e_tests_react_19:
    parameters:
      node_version:
        type: string
      e2e_executor_suffix:
        type: string
    executor: e2e<< parameters.e2e_executor_suffix >>
    steps:
      - e2e-test:
          test_path: e2e-tests/react-19

  themes_e2e_tests_development_runtime:
    parameters:
      node_version:
        type: string
      e2e_executor_suffix:
        type: string
    executor: e2e<< parameters.e2e_executor_suffix >>
    steps:
      - e2e-test:
          test_path: e2e-tests/themes
          test_command: cd development-runtime; gatsby-dev --force-install --scan-once; yarn test

  themes_e2e_tests_production_runtime:
    parameters:
      node_version:
        type: string
      e2e_executor_suffix:
        type: string
    executor: e2e<< parameters.e2e_executor_suffix >>
    steps:
      - e2e-test:
          test_path: e2e-tests/themes
          test_command: cd production-runtime; gatsby-dev --force-install --scan-once; yarn test

  e2e_tests_mdx:
    parameters:
      node_version:
        type: string
      e2e_executor_suffix:
        type: string
    executor: e2e<< parameters.e2e_executor_suffix >>
    steps:
      - e2e-test:
          test_path: e2e-tests/mdx

  e2e_tests_visual-regression:
    parameters:
      node_version:
        type: string
      e2e_executor_suffix:
        type: string
    executor: e2e<< parameters.e2e_executor_suffix >>
    steps:
      - e2e-test:
          test_path: e2e-tests/visual-regression
      - store_artifacts:
          path: e2e-tests/visual-regression/__diff_output__
      - store_test_results:
          path: e2e-tests/visual-regression/cypress/results

  e2e_tests_contentful:
    parameters:
      node_version:
        type: string
      e2e_executor_suffix:
        type: string
    executor: e2e<< parameters.e2e_executor_suffix >>
    steps:
      - e2e-test:
          test_path: e2e-tests/contentful
      # we build a second time to see if warm/cached builds are successful
      - e2e-test:
          test_path: e2e-tests/contentful
          test_command: yarn build
      - store_artifacts:
          path: e2e-tests/contentful/__diff_output__
      - store_test_results:
          path: e2e-tests/contentful/cypress/results

  e2e_tests_trailing-slash:
    parameters:
      node_version:
        type: string
      e2e_executor_suffix:
        type: string
    executor: e2e<< parameters.e2e_executor_suffix >>
    steps:
      - e2e-test:
          test_path: e2e-tests/trailing-slash
      - store_test_results:
          path: e2e-tests/trailing-slash/cypress/results

  e2e_tests_adapters:
    parameters:
      node_version:
        type: string
      e2e_executor_suffix:
        type: string
    executor: e2e<< parameters.e2e_executor_suffix >>
    steps:
      - e2e-test:
          test_path: e2e-tests/adapters
      - store_test_results:
          path: e2e-tests/adapters/cypress/results

  e2e_tests_adapters_monorepo:
    parameters:
      node_version:
        type: string
      e2e_executor_suffix:
        type: string
    executor: e2e<< parameters.e2e_executor_suffix >>
    steps:
      - e2e-test:
          test_path: e2e-tests/adapters
          test_command: cd workspace; gatsby-dev --force-install --scan-once; cd ..; yarn test
          pre_gatsby_dev_command: ./make-monorepo.sh
      - store_test_results:
          path: e2e-tests/adapters/cypress/results

  starters_validate:
    executor: node
    steps:
      - checkout
      - run: ./scripts/assert-changed-files.sh "starters/*|.circleci/*"
      - run: sh ./scripts/validate-starters.sh "starters/*"

  starters_publish:
    executor: node
    steps:
      - checkout
      # jq is helpful for parsing json & python required for node-gyp to build lmdb
      - run: sudo apt-get update && sudo apt-get install -y jq python3 python-is-python3
      - restore_yarn_cache:
          node_version: 18.0.0
      - <<: *install_node_modules
      - run: yarn markdown
      - run: git config --global user.name "GatsbyJS Bot"
      - run: git config --global user.email "core-team@gatsbyjs.com"
      - run: sh ./scripts/publish-starters.sh "starters/*"

  update_changelogs:
    executor: node
    steps:
      - checkout
      # python is not built in and node-gyp needs it to build lmdb
      - run: sudo apt-get update && sudo apt-get install -y jq python3 python-is-python3
      - restore_yarn_cache:
          node_version: 18.0.0
      - <<: *install_node_modules
      - run: git config --global user.name "GatsbyJS Bot"
      - run: git config --global user.email "core-team@gatsbyjs.com"
      - run: node scripts/gatsby-changelog-generator/update-and-open-pr.js

  # TODO(serhalp): Test Windows on Node.js 20 and 22?
  windows_unit_tests:
    parallelism: 4
    executor:
      name: win/default
      shell: powershell.exe
    steps:
      - checkout
      - run:
          command: ./scripts/assert-changed-files.sh "packages/*|(e2e|integration)-tests/*|.circleci/*|scripts/e2e-test.sh|yarn.lock"
          shell: bash.exe
      # Restoring cache takes as long as installing node modules, so skipping
      # - restore_cache:
      #     keys:
      #       - yarn-packages-v2-{{ checksum "yarn.lock" }}-<< parameters.node_version >>
      #       - yarn-packages-v2-<< parameters.node_version >>

      - <<: *attach_to_bootstrap
      - run:
          name: Install node 18.0.0 and yarn
          command: |
            nvm install 18.0.0
            nvm alias default 18.0.0
            nvm use 18.0.0
            choco install yarn -y
      - run:
          name: Rebuild packages for windows
          command: |
            Remove-Item -Recurse -Force -Path "node_modules/sharp/"
            yarn
      - run:
          name: Run tests
          command: yarn jest --ci --runInBand ((yarn jest --listTests) | Foreach-Object {$_ -replace '.*\\packages', 'packages'} | Foreach-Object {$_ -replace '\\', '/'} | circleci tests split)
          no_output_timeout: 15m
          environment:
            NODE_OPTIONS: --max-old-space-size=2048
            NODE_NO_WARNINGS: 1
            BROWSERSLIST_IGNORE_OLD_DATA: true
            GENERATE_JEST_REPORT: "true"
            COMPILER_OPTIONS: GATSBY_MAJOR=5
            JEST_JUNIT_OUTPUT_DIR: ./test-results/jest-node/
            JEST_JUNIT_OUTPUT_NAME: results.xml
            JEST_JUNIT_REPORT_TEST_SUITE_ERRORS: "true"
      - store_test_results:
          path: ./test-results/jest-node/

  windows_adapters_smoke:
    executor:
      name: win/default
      shell: bash.exe
    steps:
      - checkout
      - run:
          command: ./scripts/assert-changed-files.sh "packages/*|(e2e|integration)-tests/*|.circleci/*|scripts/e2e-test.sh|yarn.lock"
      - <<: *attach_to_bootstrap
      - run:
          name: Install node 18.19.0, yarn and netlify-cli
          command: |
            nvm install 18.19.0
            nvm alias default 18.19.0
            nvm use 18.19.0
            npm install -g yarn netlify-cli
      - run:
          name: Clear out sharp
          command: |
            Remove-Item -Recurse -Force -Path "node_modules/sharp/"
          shell: powershell.exe
      - run:
          command: yarn
      - run:
          command: mkdir -p /tmp/e2e-tests/
      - run:
          command: cp -r ./e2e-tests/adapters /tmp/e2e-tests/adapters
      - run:
          command: pwd && ls
          working_directory: /tmp/e2e-tests/adapters
      - run: # Set project dir
          command: node ./packages/gatsby-dev-cli/dist/index.js --set-path-to-repo .
      - run: # Copy over packages
          command: cd /tmp/e2e-tests/adapters && node ~/project/packages/gatsby-dev-cli/dist/index.js --force-install --scan-once
      - run: # run smoke test
          command: cd /tmp/e2e-tests/adapters && node scripts/deploy-and-run/netlify.mjs test:smoke

workflows:
  version: 2

  # Ideally, we should trigger this when any new release is created, sadly there is no easy way to do it:
  # - Can't rely on tags: GitHub won't send webhook to CircleCI when there are more than 3 tags in one push
  #   See: https://docs.github.com/en/developers/webhooks-and-events/webhooks/webhook-events-and-payloads#push
  # - Can't rely on pushes to "release/*" branches because we have "Only build pull requests" option enabled
  #   (so pushes without pull requests are ignored by CircleCI)
  nightly-update-changelogs:
    triggers:
      - schedule:
          cron: "0 0 * * 1,2,3,4,5"
          filters:
            branches:
              only:
                - master
    jobs:
      - update_changelogs

  build-test:
    jobs:
      - bootstrap:
          name: "bootstrap-<< matrix.node_version >>"
          matrix:
            parameters:
              node_version: ["18.2.0", "20.19", "22.13"]
      - lint
      - typecheck:
          requires:
            - bootstrap-18.2.0
      - windows_unit_tests:
          <<: *ignore_docs
          requires:
            - bootstrap-18.2.0
      - windows_adapters_smoke:
          requires:
            - bootstrap-18.2.0
      - unit_tests_node18:
          <<: *ignore_docs
          requires:
            - bootstrap-18.2.0
      - unit_tests_node20:
          <<: *ignore_docs
          requires:
            - bootstrap-20.19
      - unit_tests_node22:
          <<: *ignore_docs
          requires:
            - bootstrap-22.13
      - integration_tests_gatsby_source_wordpress:
          <<: *integration-test-workflow
      - integration_tests_long_term_caching:
          <<: *integration-test-workflow
      - integration_tests_cache_resilience:
          <<: *integration-test-workflow
      - integration_tests_gatsby_pipeline:
          <<: *integration-test-workflow
      - integration_tests_structured_logging:
          <<: *integration-test-workflow
      - integration_tests_artifacts:
          <<: *integration-test-workflow
      - integration_tests_ssr:
          <<: *integration-test-workflow
      - integration_tests_images:
          <<: *integration-test-workflow
      - integration_tests_functions:
          <<: *integration-test-workflow
      - integration_tests_head_function_export:
          <<: *integration-test-workflow
      - integration_tests_esm_in_gatsby_files:
          <<: *integration-test-workflow
      - integration_tests_lmdb_regeneration:
          <<: *integration-test-workflow
      - integration_tests_gatsby_cli:
          <<: *integration-test-workflow
      - e2e_tests_pnp:
          <<: *e2e-test-workflow
      - e2e_tests_pnpm:
          <<: *e2e-test-workflow
      - e2e_tests_path-prefix:
          <<: *e2e-test-workflow
      - e2e_tests_visual-regression:
          <<: *e2e-test-workflow
      - e2e_tests_contentful:
          <<: *e2e-test-workflow
      - e2e_tests_mdx:
          <<: *e2e-test-workflow
      - e2e_tests_trailing-slash:
          <<: *e2e-test-workflow
      - e2e_tests_adapters:
          <<: *e2e-test-workflow
      - e2e_tests_adapters_monorepo:
          <<: *e2e-test-workflow
      - e2e_tests_development_runtime_with_react_18:
          <<: *e2e-test-workflow
      - e2e_tests_production_runtime_with_react_18:
          <<: *e2e-test-workflow
      - e2e_tests_development_runtime_with_react_19:
          <<: *e2e-test-workflow
      - e2e_tests_production_runtime_with_react_19:
          <<: *e2e-test-workflow
      - e2e_tests_react_19:
          <<: *e2e-test-workflow
      - themes_e2e_tests_production_runtime:
          <<: *e2e-test-workflow
      - themes_e2e_tests_development_runtime:
          <<: *e2e-test-workflow
      - starters_validate:
          <<: *ignore_master
      - starters_publish:
          filters:
            branches:
              only:
                - master
