#!/usr/bin/env node

const Configstore = require("configstore");
const pkg = require("../package.json");
const argv = require("yargs").array("packages").argv;
const isAbsolute = require("is-absolute");
const _ = require("lodash");

const conf = new Configstore(pkg.name);

const fs = require("fs-extra");
const havePackageJsonFile = fs.existsSync("package.json");

if (!havePackageJsonFile) {
  console.log("Current folder must have a package.json file!");
  process.exit();
}

const localPkg = JSON.parse(fs.readFileSync("package.json"));
const packages = Object.keys(localPkg.dependencies);
const gatsbyPackages = packages.filter(p => p.startsWith("gatsby"));
console.log(gatsbyPackages)

// Test that the path is absolute
if (argv.setPathToRepo && !isAbsolute(argv.setPathToRepo)) {
  console.log("The path to the repo has to be absolute!");
  process.exit();
}

if (argv.setPathToRepo) {
  console.log("Saving path to your Gatsby repo");
  conf.set("gatsby-location", argv.setPathToRepo);
  process.exit();
}

const gatsbyLocation = conf.get("gatsby-location");

if (!gatsbyLocation) {
  console.log(
    `
You haven't set the path yet to your cloned
version of Gatsby. Do so now by running:

gatsby-dev --set-path-to-repo /path/to/my/cloned/version/gatsby
        `
  );
  process.exit();
}

if (!argv.packages && _.isEmpty(gatsbyPackages)) {
  console.log(
    `
You haven't got any gatsby dependencies into your current package.json

You probably want to pass in a list of packages to start
developing on! For example:

gatsby-dev --packages gatsby gatsby-typegen-remark
`
  );
  process.exit();
}

const watch = require("../");
watch(gatsbyLocation, argv.packages || gatsbyPackages);
